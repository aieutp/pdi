WITH RELACIONES AS (
    SELECT PARTY_ID_TO, PARTY_ID_FROM 
    FROM SGPDI.TB_PDI_PARTY_RELATIONSHIP
),
RECURSIVE_TREE(PLAN_ID, PARTY_ID, NODE_TYPE_ID, DISPLAY_NAME, ID_PROYECTO, PROYECTO, ID_PROGRAMA, PROGRAMA, ID_PILAR, PILAR) AS (
    SELECT PLAN_ID, PARTY_ID, NODE_TYPE_ID, DISPLAY_NAME, 0 AS ID_PROYECTO,'' AS PROYECTO, 0 AS ID_PROGRAMA, '' AS PROGRAMA, PARTY_ID AS ID_PILAR, DISPLAY_NAME AS PILAR
    FROM SGPDI.TB_PDI_PARTY_NODE
    WHERE NODE_TYPE_ID = 'NODO_PILAR' AND PLAN_ID IN (___ANIO___) AND DATABASE_ACTION = '0'

    UNION ALL

    SELECT P.PLAN_ID, P.PARTY_ID, P.NODE_TYPE_ID, P.DISPLAY_NAME,
           CASE WHEN P.NODE_TYPE_ID = 'NODO_PROYECTO' THEN P.PARTY_ID ELSE T.ID_PROYECTO END,
           CASE WHEN P.NODE_TYPE_ID = 'NODO_PROYECTO' THEN P.DISPLAY_NAME ELSE PROYECTO END,
           CASE WHEN P.NODE_TYPE_ID = 'NODO_PROGRAMA' THEN P.PARTY_ID ELSE T.ID_PROGRAMA END,
           CASE WHEN P.NODE_TYPE_ID = 'NODO_PROGRAMA' THEN P.DISPLAY_NAME ELSE PROGRAMA END,
           T.ID_PILAR, T.PILAR
    FROM SGPDI.TB_PDI_PARTY_NODE P
    JOIN RELACIONES R ON P.PARTY_ID = R.PARTY_ID_FROM
    JOIN RECURSIVE_TREE T ON R.PARTY_ID_TO = T.PARTY_ID
    WHERE P.PLAN_ID IN (___ANIO___) AND DATABASE_ACTION = '0'
)

SELECT * FROM RECURSIVE_TREE
WHERE NODE_TYPE_ID <> 'NODO_ACTIVIDAD'
ORDER BY PLAN_ID, ID_PILAR, ID_PROGRAMA, ID_PROYECTO